<div class="table-operations" style="margin-bottom: 16px">
  <button nz-button nzType="primary" [routerLink]="['new']"><i nz-icon nzType="user-add"></i>Create User</button>
</div>

<nz-table
  #userTable
  [nzFrontPagination]="false"
  [nzData]="users"
  nzBordered
  nzShowPagination
  nzShowSizeChanger
  [nzSize]="'small'"
  [nzTotal]="total"
  [nzLoading]="loading"
  [nzPageIndex]="page"
  [nzPageSize]="count"
  (nzQueryParams)="onQueryParamsChange($event)">
  <thead>
    <tr>
      <th>ID</th>
      <th>First name</th>
      <th>Last name</th>
      <th>Email</th>
      <th>Role</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let u of userTable.data">
      <td>{{ u.id }}</td>
      <td>{{ u.first_name }}</td>
      <td>{{ u.last_name }}</td>
      <td>{{ u.email }}</td>
      <td>
        <nz-tag [nzColor]="getRoleTagColor(u.role)">
          {{ u.role }}
        </nz-tag>
      </td>
      <td>
        <button nz-button nzType="link" (click)="openEditDrawer(u)">
          <i nz-icon nzType="edit" nzTheme="outline"></i>
        </button>
        <button
          nz-button
          nzType="link"
          nz-popconfirm
          nzPopconfirmTitle="Are you sure you want to delete this user?"
          nzPopconfirmPlacement="left"
          (nzOnConfirm)="deleteUser(u.id)"
          nzOkText="Yes"
          nzCancelText="No">
          <i nz-icon nzType="delete" nzTheme="outline" style="color: #ff4d4f"></i>
        </button>
        <button nz-button nzType="link" (click)="openViewDrawer(u)">
          <i nz-icon nzType="eye" nzTheme="outline"></i>
        </button>
      </td>
    </tr>
  </tbody>
</nz-table>

<!-- User Drawer for both edit and view -->
<nz-drawer [nzVisible]="drawerVisible" [nzWidth]="500" [nzClosable]="true" [nzTitle]="drawerTitle" [nzFooter]="footerTpl" (nzOnClose)="closeDrawer()">
  <ng-container *nzDrawerContent>
    <!-- Edit Mode -->
    <form nz-form *ngIf="drawerMode === 'edit' && editForm" [formGroup]="editForm" (ngSubmit)="updateUser()">
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>First Name</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Please input first name!">
          <input nz-input formControlName="first_name" placeholder="First Name" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Last Name</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Please input last name!">
          <input nz-input formControlName="last_name" placeholder="Last Name" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Email</nz-form-label>
        <nz-form-control [nzSpan]="14" [nzErrorTip]="emailErrorTpl">
          <input nz-input formControlName="email" placeholder="Email" type="email" />
          <ng-template #emailErrorTpl let-control>
            <ng-container *ngIf="control.hasError('required')">Please input email!</ng-container>
            <ng-container *ngIf="control.hasError('email')">Please enter a valid email address!</ng-container>
          </ng-template>
        </nz-form-control>
      </nz-form-item>
    </form>

    <!-- View Mode -->
    <div class="user-details" *ngIf="drawerMode === 'view' && selectedUser">
      <nz-descriptions nzBordered [nzColumn]="1">
        <nz-descriptions-item nzTitle="ID">{{ selectedUser.id }}</nz-descriptions-item>
        <nz-descriptions-item nzTitle="First Name">{{ selectedUser.first_name }}</nz-descriptions-item>
        <nz-descriptions-item nzTitle="Last Name">{{ selectedUser.last_name }}</nz-descriptions-item>
        <nz-descriptions-item nzTitle="Email">{{ selectedUser.email }}</nz-descriptions-item>
        <nz-descriptions-item nzTitle="Role">
          <nz-tag [nzColor]="getRoleTagColor(selectedUser.role)">
            {{ selectedUser.role }}
          </nz-tag>
        </nz-descriptions-item>
      </nz-descriptions>
    </div>
  </ng-container>

  <!-- Footer Template -->
  <ng-template #footerTpl>
    <div style="text-align: right">
      <!-- View Mode Footer -->
      <ng-container *ngIf="drawerMode === 'view'">
        <button nz-button nzType="default" (click)="closeDrawer()">Close</button>
      </ng-container>

      <!-- Edit Mode Footer -->
      <ng-container *ngIf="drawerMode === 'edit'">
        <button nz-button nzType="default" (click)="closeDrawer()" style="margin-right: 8px">Cancel</button>
        <button nz-button nzType="primary" (click)="updateUser()" [disabled]="!editForm?.valid || isSubmitting">
          <i nz-icon nzType="save"></i> Save Changes
        </button>
      </ng-container>
    </div>
  </ng-template>
</nz-drawer>
