<div class="table-operations" style="margin-bottom: 16px">
  <button nz-button nzType="primary" [routerLink]="['new']"><i nz-icon nzType="plus"></i>Create Class</button>
</div>

<nz-table
  #classTable
  [nzFrontPagination]="false"
  [nzData]="classes"
  nzBordered
  nzShowPagination
  nzShowSizeChanger
  [nzSize]="'small'"
  [nzTotal]="total"
  [nzLoading]="loading"
  [nzPageIndex]="page"
  [nzPageSize]="count"
  (nzQueryParams)="onQueryParamsChange($event)">
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Teacher ID</th>
      <th>Teacher</th>
      <th>Students count</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let c of classTable.data">
      <td>{{ c.id }}</td>
      <td>{{ c.name }}</td>
      <td>
        {{ c.teacher_user_id }}
      </td>
      <td>
        <nz-icon nzType="user" nzTheme="outline" />
        {{ c.teacher_user.first_name + ' ' + c.teacher_user.last_name }}
      </td>
      <td>
        {{ c.enrolled_students_count || 0 }}
      </td>
      <td>
        <button nz-button nzType="link" (click)="openEditDrawer(c)">
          <i nz-icon nzType="edit" nzTheme="outline"></i>
        </button>
        <button
          nz-button
          nzType="link"
          nz-popconfirm
          nzPopconfirmTitle="Are you sure you want to delete this class?"
          nzPopconfirmPlacement="left"
          (nzOnConfirm)="deleteClass(c.id)"
          nzOkText="Yes"
          nzCancelText="No">
          <i nz-icon nzType="delete" nzTheme="outline" style="color: #ff4d4f"></i>
        </button>
        <button nz-button nzType="link" (click)="openViewDrawer(c)">
          <i nz-icon nzType="eye" nzTheme="outline"></i>
        </button>
      </td>
    </tr>
  </tbody>
</nz-table>

<!-- Class Drawer for both edit and view -->
<nz-drawer
  [nzVisible]="drawerVisible"
  [nzSize]="'large'"
  [nzClosable]="true"
  [nzTitle]="drawerTitle"
  [nzFooter]="footerTpl"
  (nzOnClose)="closeDrawer()">
  <ng-container *nzDrawerContent>
    <!-- Edit Mode -->
    <form nz-form *ngIf="drawerMode === 'edit' && editForm" [formGroup]="editForm" (ngSubmit)="updateClass()">
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Class Name</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Please input class name!">
          <input nz-input formControlName="name" placeholder="Class Name" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Teacher</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Please select a teacher!">
          <nz-select
            formControlName="teacher_user_id"
            nzShowSearch
            nzServerSearch
            nzAllowClear
            nzPlaceHolder="Search for teacher"
            [nzShowArrow]="false"
            [nzFilterOption]="nzFilterOption"
            (nzOnSearch)="searchTeachers($event)"
            [nzLoading]="isSearchingTeachers">
            <nz-option *ngFor="let teacher of teacherSearchResults" [nzValue]="teacher.id" [nzLabel]="getTeacherDisplayName(teacher)">
              <nz-icon nzType="user" nzTheme="outline" />
            </nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
    </form>

    <!-- View Mode -->

    <div class="class-details" *ngIf="drawerMode === 'view' && selectedClass">
      <nz-descriptions nzBordered [nzColumn]="1">
        <nz-descriptions-item nzTitle="ID">{{ selectedClass.id }}</nz-descriptions-item>
        <nz-descriptions-item nzTitle="Class Name">{{ selectedClass.name }}</nz-descriptions-item>
        <nz-descriptions-item nzTitle="Teacher ID">{{ selectedClass.teacher_user_id }}</nz-descriptions-item>
        <nz-descriptions-item nzTitle="Teacher" *ngIf="teachers.length > 0">
          {{ getTeacherName(selectedClass.teacher_user_id) }}
        </nz-descriptions-item>
      </nz-descriptions>
    </div>

    <!-- Add this inside your drawer content, after the class details section -->
    <div *ngIf="selectedClass">
      <nz-divider></nz-divider>

      <!-- Edit Mode - Full student management features -->
      <div class="student-management" *ngIf="drawerMode === 'edit'">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px">
          <h3>Enrolled Students</h3>

          <!-- Add Student Form -->
          <div style="display: flex; gap: 8px; align-items: center">
            <nz-select
              nzShowSearch
              nzPlaceHolder="Select student to add"
              [(ngModel)]="selectedStudentId"
              [nzLoading]="loadingAvailableStudents"
              (nzOnSearch)="searchStudents($event)"
              style="min-width: 200px">
              <nz-option
                *ngFor="let student of studentSearchResults"
                [nzValue]="student.id"
                [nzLabel]="getStudentDisplayName(student)"
                [nzDisabled]="isStudentEnrolled(student.id)">
              </nz-option>
            </nz-select>
            <button
              nz-button
              nzType="primary"
              [nzLoading]="isAddingStudent"
              [disabled]="!selectedStudentId || isAddingStudent"
              (click)="addStudentToClass()">
              <i nz-icon nzType="user-add"></i> Add Student
            </button>
          </div>
        </div>

        <div *ngIf="loadingStudents">
          <nz-spin nzTip="Loading students..."></nz-spin>
        </div>

        <div *ngIf="!loadingStudents">
          <nz-table
            #editStudentsTable
            [nzData]="enrolledStudents"
            [nzPageSize]="10"
            [nzLoading]="loadingStudents"
            [nzShowPagination]="enrolledStudents.length > 10">
            <thead>
              <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let student of editStudentsTable.data">
                <td>{{ student.student_user?.id }}</td>
                <td>{{ student.student_user?.first_name }}</td>
                <td>{{ student.student_user?.last_name }}</td>
                <td>{{ student.student_user?.email }}</td>
                <td>
                  <button
                    nz-button
                    nzType="link"
                    nz-popconfirm
                    nzPopconfirmTitle="Are you sure you want to remove this student from the class?"
                    nzPopconfirmPlacement="left"
                    (nzOnConfirm)="removeStudentFromClass(student.id)"
                    nzOkText="Yes"
                    nzCancelText="No">
                    <i nz-icon nzType="user-delete" nzTheme="outline" style="color: #ff4d4f"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </nz-table>
        </div>
      </div>

      <!-- View Mode - Read-only student list -->
      <div class="student-list" *ngIf="drawerMode === 'view'">
        <h3>Enrolled Students</h3>

        <div *ngIf="loadingStudents">
          <nz-spin nzTip="Loading students..."></nz-spin>
        </div>

        <div *ngIf="!loadingStudents">
          <nz-table
            #viewStudentsTable
            [nzData]="enrolledStudents"
            [nzPageSize]="10"
            [nzLoading]="loadingStudents"
            [nzShowPagination]="enrolledStudents.length > 10">
            <thead>
              <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let student of viewStudentsTable.data">
                <td>{{ student.student_user?.id }}</td>
                <td>{{ student.student_user?.first_name }}</td>
                <td>{{ student.student_user?.last_name }}</td>
                <td>{{ student.student_user?.email }}</td>
              </tr>
            </tbody>
          </nz-table>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Footer Template -->
  <ng-template #footerTpl>
    <div style="text-align: right">
      <!-- View Mode Footer -->
      <ng-container *ngIf="drawerMode === 'view'">
        <button nz-button nzType="default" (click)="closeDrawer()">Close</button>
      </ng-container>

      <!-- Edit Mode Footer -->
      <ng-container *ngIf="drawerMode === 'edit'">
        <button nz-button nzType="default" (click)="closeDrawer()" style="margin-right: 8px">Cancel</button>
        <button nz-button nzType="primary" (click)="updateClass()" [disabled]="!editForm?.valid || isSubmitting">
          <i nz-icon nzType="save"></i> Save Changes
        </button>
      </ng-container>
    </div>
  </ng-template>
</nz-drawer>
